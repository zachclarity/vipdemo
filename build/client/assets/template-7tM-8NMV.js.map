{"version":3,"file":"template-7tM-8NMV.js","sources":["../../../app/routes/_withNav+/_withSideBar+/_manage+/template.tsx"],"sourcesContent":["import { DeleteButton, LinkButton } from '@components/ui/Buttons';\nimport ErrorReport from '@components/ui/ErrorReport';\nimport PageHeader from '@components/ui/PageHeader';\nimport { RichTextView } from '@components/ui/RichText/Viewer';\nimport { Table } from '@components/ui/table/Table';\nimport { TailwindWidth } from '@lib/constants';\nimport { useRootLayoutData } from '@lib/hooks/useMatchesData';\nimport { Attribute, isPrismaKnownError } from '@lib/utils';\nimport { Prisma, type Template } from '@prisma/client';\nimport type { ActionFunctionArgs, LoaderFunctionArgs } from '@remix-run/node';\nimport { json } from '@remix-run/node';\nimport { Outlet, useFetcher, useLoaderData } from '@remix-run/react';\nimport { requireUser, requireUserAsObject } from '@services/user.server';\nimport React from 'react';\nimport { AuthorizationError } from 'remix-auth';\nimport { jsonWithError, jsonWithSuccess } from 'remix-toast';\nimport z, { ZodError } from 'zod';\nimport { getOrgBeingViewed } from './.server/org.queries';\nimport { deleteTemplate } from './.server/template.queries';\nimport useIsAdmin from '@lib/hooks/useIsAdmin';\n\nexport const loader = async ({ request }: LoaderFunctionArgs) => {\n  const { currentOrg } = await requireUserAsObject(request, {\n    permissions: Attribute.TEMPLATES_READWRITEDELETE,\n  });\n\n  const { orgBeingViewed } = await getOrgBeingViewed(\n    {\n      defaultOrgId: currentOrg.uuid,\n      searchParams: new URL(request.url).searchParams,\n    },\n    true\n  );\n\n  return json({\n    orgBeingViewed: { ...orgBeingViewed },\n  }, {\n    headers: {\n      'X-Frame-Options': 'SAMEORIGIN',\n    },\n  });\n};\n\nexport const action = async ({ request }: ActionFunctionArgs) => {\n  try {\n    await requireUser(request, {\n      options: { redirectOnFailure: false },\n      permissions: Attribute.TEMPLATES_READWRITEDELETE,\n    });\n\n    const deleteTemplateSchema = z.object({\n      id: z.string(),\n    });\n\n    const { id } = deleteTemplateSchema.parse(\n      Object.fromEntries(await request.formData())\n    );\n\n    const result = await deleteTemplate(id);\n\n    if (result === -1)\n      return jsonWithError(\n        {\n          status: 'error',\n          message:\n            'There are still items in this template. Delete the items first before deleting the template.',\n        },\n        'There are still items in the template.',\n        {\n          headers: {\n            'X-Frame-Options': 'SAMEORIGIN',\n          },\n        }\n      );\n\n    return jsonWithSuccess({ status: 'ok' }, 'Template Deleted!', {\n      headers: {\n        'X-Frame-Options': 'SAMEORIGIN',\n      },\n    });\n  } catch (e) {\n    console.error(e);\n    if (e instanceof Error) {\n      if (e instanceof AuthorizationError) {\n        return jsonWithError(\n          { status: 'error', error: 'Authorization Error.' },\n          'User is not authorized.',\n          {\n            headers: {\n              'X-Frame-Options': 'SAMEORIGIN',\n            },\n          }\n        );\n      } else if (e instanceof ZodError) {\n        return jsonWithError(\n          {\n            status: 'error',\n            message: 'There was a validation error',\n            issues: e.issues,\n          },\n          'There was an error.',\n          {\n            headers: {\n              'X-Frame-Options': 'SAMEORIGIN',\n            },\n          }\n        );\n      } else if (\n        e instanceof Prisma.PrismaClientKnownRequestError &&\n        isPrismaKnownError(e)\n      ) {\n        if (e.code === 'P2003')\n          return jsonWithError(\n            {\n              status: 'error',\n              message:\n                'There are still items in this template. Delete the items first before deleting the template.',\n            },\n            'There are still items in the template.',\n            {\n              headers: {\n                'X-Frame-Options': 'SAMEORIGIN',\n              },\n            }\n          );\n      } else {\n        return jsonWithError(\n          { status: 'error', message: e.message },\n          'There was an error.',\n          {\n            headers: {\n              'X-Frame-Options': 'SAMEORIGIN',\n            },\n          }\n        );\n      }\n    }\n  }\n};\n\nexport default function TemplateIndex() {\n  const deleteFetcher = useFetcher();\n\n  const { orgBeingViewed } = useLoaderData<typeof loader>();\n  const rolesData = useRootLayoutData('roles');\n  const { isAdmin } = useIsAdmin(rolesData);\n\n  const tableContents = [\n    {\n      header: 'Name',\n      key: 'name',\n    },\n    {\n      header: 'Description',\n      key: 'description',\n      width: TailwindWidth['W_3/5'],\n      render: function (description: string) {\n        return (\n          <div className=\"line-clamp-2\">\n            <RichTextView>{description}</RichTextView>\n          </div>\n        );\n      },\n    },\n    {\n      header: 'Active',\n      key: '_count.userChecklists',\n      render: (count: string) => count || 0,\n    },\n  ];\n\n  return (\n    <section>\n      <PageHeader org={orgBeingViewed} pageTitle=\"Available Templates:\" />\n      <div className=\"my-5\">\n        <LinkButton\n          variant=\"green\"\n          to={{\n            pathname: `/template/create`,\n            searchParams: { org: orgBeingViewed.uuid },\n          }}>\n          Create New Template\n        </LinkButton>\n      </div>\n      {orgBeingViewed.templates!.length > 0 ? (\n        <Table cells={tableContents}>\n          <Table.HeaderRow />\n          <Table.Body>\n            {orgBeingViewed.templates?.map((template: Template) => (\n              <Table.Row key={template.id} item={template}>\n                <Table.ButtonCell className=\"text-right\">\n                  <LinkButton\n                    variant=\"gray\"\n                    to={{\n                      pathname: `/template/${template.id}`,\n                      searchParams: { org: orgBeingViewed.uuid },\n                    }}>\n                    View\n                  </LinkButton>\n                  {!isAdmin && (\n                    <deleteFetcher.Form method=\"post\" className=\"inline m-3\">\n                      <input type=\"hidden\" name=\"id\" value={template.id} />\n                      <DeleteButton name=\"_action\" value=\"delete\" type=\"submit\">\n                        Delete\n                      </DeleteButton>\n                    </deleteFetcher.Form>\n                  )}\n                </Table.ButtonCell>\n              </Table.Row>\n            ))}\n          </Table.Body>\n        </Table>\n      ) : (\n        'No templates to show.'\n      )}\n      <Outlet />\n    </section>\n  );\n}\n\nexport const ErrorBoundary = ErrorReport;\n"],"names":["TemplateIndex","deleteFetcher","useFetcher","orgBeingViewed","useLoaderData","rolesData","useRootLayoutData","isAdmin","useIsAdmin","tableContents","header","key","width","TailwindWidth","render","description","className","children","jsx","RichTextView","count","PageHeader","org","pageTitle","LinkButton","variant","to","pathname","searchParams","uuid","templates","length","jsxs","Table","cells","HeaderRow","Body","map","template","Row","item","ButtonCell","id","Form","method","type","name","value","DeleteButton","Outlet","ErrorBoundary","ErrorReport"],"mappings":"soCA4IA,SAAwBA,GAAgB,OACtC,MAAMC,EAAgBC,EAAW,EAE3B,CAAEC,eAAAA,CAAe,EAAIC,EAA6B,EAClDC,EAAYC,EAAkB,OAAO,EACrC,CAAEC,QAAAA,CAAQ,EAAIC,EAAWH,CAAS,EAElCI,EAAgB,CACpB,CACEC,OAAQ,OACRC,IAAK,MACP,EACA,CACED,OAAQ,cACRC,IAAK,cACLC,MAAOC,EAAc,OAAO,EAC5BC,OAAQ,SAAUC,EAAqB,CACrC,aACG,MAAI,CAAAC,UAAU,eACbC,SAACC,EAAA,IAAAC,EAAA,CAAcF,UAAY,CAAA,CAC7B,CAAA,CAEJ,CACF,EACA,CACEP,OAAQ,SACRC,IAAK,wBACLG,OAASM,GAAkBA,GAAS,CACtC,CAAA,EAGF,cACG,UACC,CAAAH,SAAA,CAAAC,EAAA,IAACG,EAAW,CAAAC,IAAKnB,EAAgBoB,UAAU,sBAAuB,CAAA,EAClEL,EAAA,IAAC,MAAI,CAAAF,UAAU,OACbC,SAAAC,EAAA,IAACM,EAAA,CACCC,QAAQ,QACRC,GAAI,CACFC,SAAU,mBACVC,aAAc,CAAEN,IAAKnB,EAAe0B,IAAK,CAC3C,EAAGZ,SAAA,qBAEL,CAAA,CACF,CAAA,EACCd,EAAe2B,UAAWC,OAAS,EACjCC,EAAA,KAAAC,EAAA,CAAMC,MAAOzB,EACZQ,SAAA,CAACC,EAAA,IAAAe,EAAME,UAAN,CAAA,CAAgB,EACjBjB,EAAAA,IAACe,EAAMG,KAAN,CACEnB,cAAea,0BAAWO,IAAKC,GAC9BpB,EAAA,IAACe,EAAMM,IAAN,CAA4BC,KAAMF,EACjCrB,SAAAe,EAAAA,KAACC,EAAMQ,WAAN,CAAiBzB,UAAU,aAC1BC,SAAA,CAAAC,EAAA,IAACM,EAAA,CACCC,QAAQ,OACRC,GAAI,CACFC,SAAU,aAAaW,EAASI,EAAE,GAClCd,aAAc,CAAEN,IAAKnB,EAAe0B,IAAK,CAC3C,EAAGZ,SAAA,MAEL,CAAA,EACC,CAACV,GACCyB,OAAA/B,EAAc0C,KAAd,CAAmBC,OAAO,OAAO5B,UAAU,aAC1CC,SAAA,CAAAC,EAAA,IAAC,SAAM2B,KAAK,SAASC,KAAK,KAAKC,MAAOT,EAASI,EAAI,CAAA,EACnDxB,EAAA,IAAC8B,GAAaF,KAAK,UAAUC,MAAM,SAASF,KAAK,SAAS5B,SAE1D,QAAA,CAAA,CAAA,CACF,CAAA,CAAA,CAEJ,CAAA,CAlBc,EAAAqB,EAASI,EAmBzB,EAEJ,CAAA,CAAA,CACF,CAAA,EAEA,8BAEDO,EAAO,CAAA,CAAA,CAAA,CACV,CAAA,CAEJ,CAEO,MAAMC,EAAgBC"}