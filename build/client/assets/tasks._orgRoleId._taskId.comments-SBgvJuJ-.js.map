{"version":3,"file":"tasks._orgRoleId._taskId.comments-SBgvJuJ-.js","sources":["../../../app/routes/_withNav+/_withSideBar+/tasks.$orgRoleId.$taskId.comments.tsx"],"sourcesContent":["import ErrorReport from '@components/ui/ErrorReport';\nimport { Modal } from '@components/ui/modals';\nimport { useRootLayoutData } from '@lib/hooks/useMatchesData';\nimport type { ActionFunctionArgs, LoaderFunctionArgs } from '@remix-run/node';\nimport { json } from '@remix-run/node';\nimport { Form, useFetcher, useLoaderData, useSearchParams } from '@remix-run/react';\nimport { UserIcon, UserCircleIcon } from '@heroicons/react/24/solid';\nimport { useEffect, useRef, useState } from 'react';\nimport { getChecklistItem } from './.server/tasks.queries';\nimport { Attribute } from '@lib/utils';\nimport { requireUser, requireUserAsObject } from '@services/user.server';\nimport { AuthorizationError } from 'remix-auth';\nimport { jsonWithSuccess, jsonWithError } from 'remix-toast';\nimport { z } from 'zod';\nimport { markRead, sendMessage } from '../_noSideBar+/.server/checklist.queries';\nimport { MessageContainer } from '@components/ui/Message';\nimport { ChevronDoubleLeftIcon } from '@heroicons/react/24/outline';\nimport { comment } from 'postcss';\n\nexport const loader = async ({ params, request }: LoaderFunctionArgs) => {\n  const { taskId, orgRoleId } = params;\n  if (!taskId) {\n    throw json({ status: 'error', error: 'roleId is required.' });\n  }\n  const userId = await requireUser(request);\n\n  const searchQuery = (new URL(request.url)).searchParams;\n\n  const internalOnly = searchQuery.get('internal');\n\n  const [item, comments] = await getChecklistItem(taskId, {internalOnly: internalOnly === 'true'});\n\n\n  return json({ item, comments, orgRoleId, userId });\n};\n\nexport async function action ({ request }: ActionFunctionArgs) {\n  const cookieUserId = await requireUser(request);\n  const updateTaskSchema = z.object({\n    itemId: z.string().optional(),\n    postedById: z.string().optional(),\n    userId: z.literal(cookieUserId).optional(),\n    internal: z.enum(['true', 'false']).transform((value) => value === 'true').optional(),\n    content: z.string().optional(),\n    commentId: z.string().optional(),\n    _action: z.union([\n      z.literal('send'),\n      z.literal('markRead')]),\n  });\n\n  try {\n    \n    await requireUser(request, {\n      options: { redirectOnFailure: false },\n      permissions: Attribute.TASKS_READWRITE,\n    });\n     \n    const { itemId, userId, _action, content, postedById, internal, commentId} =\n        updateTaskSchema.parse(\n          Object.fromEntries((await request.formData()).entries())\n        );\n    \n    if (_action === 'send') {\n      \n      await sendMessage(itemId, postedById ?? '', content ?? '', internal);\n      return json({ status: 'success' });\n    }\n    \n    if (_action === 'markRead') {\n      const items: number[] = Array.from(JSON.parse(decodeURIComponent(commentId)))\n      await markRead(items, userId as string);\n      return json({ status: 'success' });\n    }\n    \n  } catch (error) {\n    console.error('Error during approval: ', error);\n    if (error instanceof Error) {\n      if (error instanceof AuthorizationError) {\n        return jsonWithError(\n          { status: 'error', error: 'Authorization Error.' },\n          'User is not authorized.'\n        );\n      }\n      return jsonWithError(\n        { status: 'error', error: 'Failed to approve task' },\n        'There was an error.'\n      );\n    }\n  }\n}\n\n\nconst EditOrgDefaultPage = () => {\n\n  const { item, comments } = useLoaderData<typeof loader>();\n  const user = useRootLayoutData('user');\n  const sendMessageFetcher = useFetcher();\n  const markReadFetcher = useFetcher();\n  const [searchParams] = useSearchParams();\n\n  const [messageContent, setMessageContent] = useState('');\n\n  const handleInputChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n    setMessageContent(event.target.value);\n  };\n\n  const handleFormSubmit = async (event: React.FormEvent<HTMLFormElement>) => {\n    sendMessageFetcher.submit(event.target as HTMLFormElement);\n    setMessageContent('');\n  };\n\n  // function handleMarkRead() {\n  //   let messageId: Array<number> = []\n    \n  //   console.log(user, comments)\n\n  //   comments.forEach(comment => {\n  //     if(!comment.readBy.includes(user.id)){\n  //       console.log('mark as read', comment.id)\n  //       messageId.push(comment.id)\n  //     }\n  //   })\n\n  //   console.log(messageId)\n  //   for(const item of messageId){\n  //   }\n  //     const formData = new FormData();\n  //     formData.append('commentId',  encodeURIComponent(JSON.stringify(messageId)));\n  //     formData.append('userId', user.id);\n  //     formData.append('_action', 'markRead');\n  //     markReadFetcher.submit(formData, {method: 'POST'});\n  // }\n\n  // useEffect(() => {\n  //   handleMarkRead()\n  // },[])\n\n  // useEffect(() => {\n  //   console.log(markReadFetcher.state)\n  //   console.log(markReadFetcher)\n  // }, [markReadFetcher.state])\n\n  const containerRef = useRef();\n\n  return (\n    <Modal>\n      <h3 className=\"text-base font-semibold leading-6 text-gray-900 p-3\">{item?.templateItem.name}</h3>\n      <div className=\"shadow-lg w-full flex flex-col\" ref={containerRef}>\n        <MessageContainer loggedInUser={user.id} comments={comments} isModal={true}  />\n        <div className=\"p-4 border-t bg-gray-200 rounded-b-lg\">\n          <sendMessageFetcher.Form onSubmit={handleFormSubmit} method=\"POST\">\n            <input type=\"hidden\" value={item?.id} name=\"itemId\" />\n            <input type=\"hidden\" value={searchParams.get('internal') ?? 'false'} name=\"internal\" />\n            <input type=\"hidden\" value={user.id} name=\"userId\" />\n            <input\n              type=\"hidden\"\n              value={user.id}\n              name=\"postedById\"/>\n            <input type=\"hidden\" name=\"_action\" value=\"send\" />\n            <div className=\"flex gap-2\">\n              <input\n                type=\"text\"\n                name=\"content\"\n                className=\"block w-full rounded p-2 text-sm border\"\n                placeholder=\"Type a message\"\n                value={messageContent}\n                onChange={handleInputChange}\n                required/>\n              <button\n                type=\"submit\"\n                className=\"bg-blue-500 text-white py-2 px-4 rounded w-40\">\n                  Send\n              </button>\n            </div>\n          </sendMessageFetcher.Form>\n        </div>\n      </div>\n    </Modal>\n  );\n};\nexport const ErrorBoundary = ErrorReport;\nexport default EditOrgDefaultPage;\n"],"names":["EditOrgDefaultPage","item","comments","useLoaderData","user","useRootLayoutData","sendMessageFetcher","useFetcher","searchParams","useSearchParams","messageContent","setMessageContent","useState","handleInputChange","event","target","value","handleFormSubmit","submit","containerRef","useRef","Modal","children","jsx","className","templateItem","name","jsxs","ref","MessageContainer","loggedInUser","id","isModal","Form","onSubmit","method","type","get","placeholder","onChange","required","ErrorBoundary","ErrorReport"],"mappings":"s7BA4FMA,MAAAA,EAAqBA,IAAM,CAE/B,KAAM,CAAEC,KAAAA,EAAMC,SAAAA,CAAS,EAAIC,EAA6B,EAClDC,EAAOC,EAAkB,MAAM,EAC/BC,EAAqBC,EAAW,EACdA,EAAW,EAC7B,KAAA,CAACC,CAAY,EAAIC,EAAgB,EAEjC,CAACC,EAAgBC,CAAiB,EAAIC,EAAAA,SAAS,EAAE,EAEjDC,EAAqBC,GAA+C,CACtDH,EAAAG,EAAMC,OAAOC,KAAK,CACtC,EAEMC,EAAmB,MAAOH,GAA4C,CACvDR,EAAAY,OAAOJ,EAAMC,MAAyB,EACzDJ,EAAkB,EAAE,CACtB,EAiCMQ,EAAeC,EAAAA,OAAO,EAE5B,cACGC,EACC,CAAAC,SAAA,CAAAC,EAAA,IAAC,KAAG,CAAAC,UAAU,sDAAuDF,SAAArB,GAAAA,YAAAA,EAAMwB,aAAaC,IAAK,CAAA,EAC5FC,EAAA,KAAA,MAAA,CAAIH,UAAU,iCAAiCI,IAAKT,EACnDG,SAAA,CAAAC,EAAA,IAACM,GAAiBC,aAAc1B,EAAK2B,GAAI7B,SAAAA,EAAoB8B,QAAS,EAAO,CAAA,EAC7ET,EAAA,IAAC,MAAI,CAAAC,UAAU,wCACbF,SAAAK,EAAAA,KAACrB,EAAmB2B,KAAnB,CAAwBC,SAAUjB,EAAkBkB,OAAO,OAC1Db,SAAA,CAAAC,EAAA,IAAC,SAAMa,KAAK,SAASpB,MAAOf,GAAAA,YAAAA,EAAM8B,GAAIL,KAAK,QAAS,CAAA,EACpDH,EAAA,IAAC,QAAM,CAAAa,KAAK,SAASpB,MAAOR,EAAa6B,IAAI,UAAU,GAAK,QAASX,KAAK,UAAW,CAAA,EACrFH,EAAA,IAAC,SAAMa,KAAK,SAASpB,MAAOZ,EAAK2B,GAAIL,KAAK,QAAS,CAAA,EACnDH,EAAA,IAAC,QAAA,CACCa,KAAK,SACLpB,MAAOZ,EAAK2B,GACZL,KAAK,YAAA,CAAY,QAClB,QAAM,CAAAU,KAAK,SAASV,KAAK,UAAUV,MAAM,MAAO,CAAA,EACjDW,EAAA,KAAC,MAAI,CAAAH,UAAU,aACbF,SAAA,CAAAC,EAAA,IAAC,QAAA,CACCa,KAAK,OACLV,KAAK,UACLF,UAAU,0CACVc,YAAY,iBACZtB,MAAON,EACP6B,SAAU1B,EACV2B,SAAQ,EAAA,CAAA,EACVjB,EAAA,IAAC,SAAA,CACCa,KAAK,SACLZ,UAAU,gDAAgDF,SAAA,MAAA,CAE5D,CAAA,CACF,CAAA,CAAA,CACF,CAAA,CACF,CAAA,CAAA,CACF,CAAA,CAAA,CACF,CAAA,CAEJ,EACamB,EAAgBC"}